<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>data.transforms.video &mdash; CVNets: A library for training computer vision networks  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            CVNets: A library for training computer vision networks
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sample_recipes.html">Sample Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how_to.html">How To</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../data_samplers.html">Data Samplers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../en/general/README-model-zoo.html">Model Zoo</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CVNets: A library for training computer vision networks</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../transforms.html">data.transforms</a></li>
      <li class="breadcrumb-item active">data.transforms.video</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for data.transforms.video</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># For licensing see accompanying LICENSE file.</span>
<span class="c1"># Copyright (C) 2023 Apple Inc. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torchaudio</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision.io</span> <span class="kn">import</span> <span class="n">write_video</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">functional</span> <span class="k">as</span> <span class="n">FV</span>

<span class="kn">from</span> <span class="nn">data.transforms</span> <span class="kn">import</span> <span class="n">TRANSFORMATIONS_REGISTRY</span><span class="p">,</span> <span class="n">BaseTransformation</span>
<span class="kn">from</span> <span class="nn">data.transforms.utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">options.parse_args</span> <span class="kn">import</span> <span class="n">JsonValidator</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">logger</span>

<span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span> <span class="s2">&quot;bicubic&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_check_interpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">interpolation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span><span class="p">:</span>
        <span class="n">inter_str</span> <span class="o">=</span> <span class="s2">&quot;Supported interpolation modes are:&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span><span class="p">):</span>
            <span class="n">inter_str</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">inter_str</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolation</span>


<span class="k">def</span> <span class="nf">_crop_fn</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">w</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crop the video in `data`.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: A dictionary of data. The format is:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;samples&quot;:{</span>
<span class="sd">                    &quot;video&quot;: A video tensor of shape [...x H x W], where H and W are the</span>
<span class="sd">                        height and width.</span>
<span class="sd">                    &quot;audio&quot;: An audio tensor.</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        i: The height coordinate of the top left corner of the cropped rectangle.</span>
<span class="sd">        j: The width coordinate of the top left corner of the cropped rectangle.</span>
<span class="sd">        h: The height of the cropped rectangle.</span>
<span class="sd">        w: The width of the cropped rectangle.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of the same format as `data` where `data[&quot;samples&quot;][&quot;videos&quot;]` is</span>
<span class="sd">        the cropped video.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
    <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

    <span class="n">crop_image</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_image</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">crop_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span> <span class="p">:</span> <span class="n">j</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">crop_mask</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_resize_fn</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">interpolation</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resize the video in `data`.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: A dictionary of data. The format is:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;samples&quot;:{</span>
<span class="sd">                    &quot;video&quot;: A video tensor of shape [... x H x W], where H and W are the</span>
<span class="sd">                        height and width.</span>
<span class="sd">                    &quot;mask&quot;: An optional entry of the mask tensor of shape [... x H x W],</span>
<span class="sd">                        where H and W are the height and width.</span>
<span class="sd">                    &quot;audio&quot;: An audio tensor.</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        size: The size of video to resize to.</span>
<span class="sd">        interpolation: The method of interpolation to use. Choices are: &quot;bilinear&quot;,</span>
<span class="sd">        &quot;nearest&quot;, &quot;linear&quot;, &quot;bicubic&quot;, &quot;trilinear&quot;, &quot;area&quot;, &quot;nearest-exact&quot;, default to</span>
<span class="sd">        &quot;bilinear&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of the same format as `data` where `data[&quot;samples&quot;][&quot;videos&quot;]` is</span>
<span class="sd">        the cropped video.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">video</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">size_h</span><span class="p">,</span> <span class="n">size_w</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;=</span> <span class="n">h</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;=</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">h</span> <span class="o">==</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">size_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">h</span> <span class="o">/</span> <span class="n">w</span><span class="p">)</span>

            <span class="n">size_w</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">w</span> <span class="o">/</span> <span class="n">h</span><span class="p">)</span>
            <span class="n">size_h</span> <span class="o">=</span> <span class="n">size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;Supported size args are int or tuple of length 2. Got inappropriate size arg: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">size</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">interpolation</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="n">_check_interpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">tc1</span><span class="p">,</span> <span class="n">tc2</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">shape</span>
    <span class="c1"># Since video could be either NTCHW or NCTHW format, we reshape the 5D tensor into</span>
    <span class="c1"># 4D and transpose back to 5D.</span>
    <span class="n">video</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">video</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">tc1</span> <span class="o">*</span> <span class="n">tc2</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">),</span>
        <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">size_h</span><span class="p">,</span> <span class="n">size_w</span><span class="p">),</span>
        <span class="n">mode</span><span class="o">=</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="n">align_corners</span><span class="o">=</span><span class="kc">True</span> <span class="k">if</span> <span class="n">interpolation</span> <span class="o">!=</span> <span class="s2">&quot;nearest&quot;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">tc1</span><span class="p">,</span> <span class="n">tc2</span><span class="p">,</span> <span class="n">size_h</span><span class="p">,</span> <span class="n">size_w</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">size_h</span><span class="p">,</span> <span class="n">size_w</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the video tensor is the right type and shape.</span>

<span class="sd">    Args:</span>
<span class="sd">        clip: A video clip tensor of shape [N x T x C x H] or [N x C x T x H x W], where</span>
<span class="sd">        N is the number of clips, T is the number of frames of the clip, C is the number</span>
<span class="sd">        of image channels, H and W are the height and width of the frame image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Video clip is not an instance of FloatTensor.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">clip</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Video clip is not a 5-d tensor (NTCHW or NCTHW).&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="ToTensor"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.ToTensor">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;to_tensor&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ToTensor</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method converts an image into a tensor.</span>

<span class="sd">    .. note::</span>
<span class="sd">        We do not perform any mean-std normalization. If mean-std normalization is</span>
<span class="sd">        desired, please modify this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ToTensor.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.ToTensor.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="c1"># [N, C, T, H, W] or [N, T, C, H, W].</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">):</span>
            <span class="c1"># Convert to float, and normalize between 0 and 1.</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span> <span class="o">/</span> <span class="mf">255.0</span>

        <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="SaveInputs"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.SaveInputs">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;save-inputs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SaveInputs</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<div class="viewcode-block" id="SaveInputs.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.SaveInputs.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span>
        <span class="n">get_frame_captions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves the clips that are returned by VideoDataset.__getitem__() to disk</span>
<span class="sd">        for debugging use cases. This transformation operates on multiple clips that</span>
<span class="sd">        are extracted out of a single raw video. The video and audio of the clips are</span>
<span class="sd">        concatenated and saved into 1 video file.</span>

<span class="sd">        1 raw input video ==&gt; VideoDataset.__getitem__() ==&gt;</span>
<span class="sd">            multiple clips in data[&quot;samples&quot;][&quot;video&quot;] ==&gt; SaveInputs() ==&gt;</span>
<span class="sd">            1 output debugging video.</span>

<span class="sd">        This is useful for visualizing training and/or validation videos to make</span>
<span class="sd">        sure preprocessing logic is behaving as expected.</span>

<span class="sd">        Args:</span>
<span class="sd">            opts: Command line options.</span>
<span class="sd">            get_frame_captions: If provided, this function returns a list of strings</span>
<span class="sd">                (one string per video frame). The frame captions will be added to the</span>
<span class="sd">                video as subtitles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_captions</span> <span class="o">=</span> <span class="n">get_frame_captions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.save_inputs.enable&quot;</span><span class="p">)</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.save_inputs.save_dir&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span> <span class="ow">and</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Please provide value for --video_augmentation.save-inputs.save-dir&quot;</span>
            <span class="p">)</span>
        <span class="n">process_start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span><span class="o">.</span><span class="n">create_time</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">process_start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symlink_to_original</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.save_inputs.symlink_to_original&quot;</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="n">original_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
        <span class="n">output_video_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dir</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">__</span><span class="si">{</span><span class="n">original_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_video_with_annotations</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">output_video_path</span><span class="o">=</span><span class="n">output_video_path</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">symlink_to_original</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span>
                <span class="n">original_path</span><span class="p">,</span>
                <span class="n">output_video_path</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.original.</span><span class="si">{</span><span class="n">output_video_path</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="SaveInputs.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.SaveInputs.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.save-inputs.save-dir&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to the folder for saving output debugging videos.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.save-inputs.add-labels&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If set, write the class label on each frame of the video.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.save-inputs.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If False do nothing (default is False).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.save-inputs.symlink-to-original&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If True, a symlink to original video sample will be created besides&quot;</span>
            <span class="s2">&quot;the saved inputs for easier debugging.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_srt_format_timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">millis</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">mm</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">hh</span><span class="o">&lt;</span><span class="mi">10</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">hh</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="mi">0</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">mm</span><span class="o">&lt;</span><span class="mi">10</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="n">mm</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">ss</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">millis</span><span class="si">:</span><span class="s2">0&gt;3</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="SaveInputs.save_video_with_annotations"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.SaveInputs.save_video_with_annotations">[docs]</a>    <span class="k">def</span> <span class="nf">save_video_with_annotations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
        <span class="n">output_video_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save a video with audio and captions.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: Dataset output dict. Schema: {</span>
<span class="sd">                &quot;samples&quot;: {</span>
<span class="sd">                    &quot;video&quot;: Tensor[N x T X C x H x W],</span>
<span class="sd">                    &quot;audio&quot;: Tensor[N x T_audio x C],  # Optional</span>
<span class="sd">                    &quot;audio_raw&quot;: Tensor[N x T_audio x C],  # Optional - if provided,</span>
<span class="sd">                                                           # &quot;audio&quot; will be ignored.</span>
<span class="sd">                    &quot;metadata&quot;: {</span>
<span class="sd">                        &quot;video_fps&quot;: Union[float,int],</span>
<span class="sd">                        &quot;audio_fps&quot;: Union[float,int],</span>
<span class="sd">                    }</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">            output_video_path: Path for saving the video.</span>
<span class="sd">            get_frame_captions: A callback that receives @data as input and returns a</span>
<span class="sd">               list of captions (one string per video frame). If provided, the captions</span>
<span class="sd">               will be added to the output video as subtitles.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>  <span class="c1"># N x T x C x H x W</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">video</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># (N*T) x C x H x W</span>
        <span class="n">video_fps</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;video_fps&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;audio_raw&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;audio_raw&quot;</span><span class="p">]</span>  <span class="c1"># N x T_audio x C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audio&quot;</span><span class="p">)</span>  <span class="c1"># N x T_audio x C</span>

        <span class="k">if</span> <span class="n">audio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">audio</span> <span class="o">=</span> <span class="n">audio</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">audio</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>  <span class="c1"># N*T_audio x C</span>
            <span class="n">audio_fps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span><span class="s2">&quot;audio_fps&quot;</span><span class="p">]))</span>

        <span class="n">video</span> <span class="o">=</span> <span class="p">(</span><span class="n">video</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">permute</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># N x H x W x C</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="n">output_video_path</span><span class="o">.</span><span class="n">suffix</span>
        <span class="k">assert</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;.mp4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.mov&quot;</span><span class="p">,</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> format is not supported by SaveInputs yet.&quot;</span>
        <span class="n">output_video_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">audio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_captions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_dir</span><span class="p">:</span>
                <span class="n">tmp_video</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;video&quot;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">)</span>
                <span class="n">write_video</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp_video</span><span class="p">),</span> <span class="n">video_array</span><span class="o">=</span><span class="n">video</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">video_fps</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ffmpeg&quot;</span><span class="p">,</span> <span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">tmp_video</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">audio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tmp_audio</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;audio.wav&quot;</span><span class="p">))</span>
                    <span class="n">torchaudio</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tmp_audio</span><span class="p">,</span> <span class="n">audio</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">audio_fps</span><span class="p">)</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-i&quot;</span><span class="p">,</span> <span class="n">tmp_audio</span><span class="p">])</span>

                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-c:v&quot;</span><span class="p">,</span> <span class="s2">&quot;libx264&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">audio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;-c:a&quot;</span><span class="p">,</span> <span class="s2">&quot;aac&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_captions</span><span class="p">:</span>
                    <span class="n">captions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_frame_captions</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">tmp_srt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;subtitle.srt&quot;</span><span class="p">))</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_srt</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">srt</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">caption</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">captions</span><span class="p">):</span>
                            <span class="n">srt</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_srt_format_timestamp</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">video_fps</span><span class="p">)</span><span class="si">}</span><span class="s2"> --&gt; &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_srt_format_timestamp</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">video_fps</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">caption</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="s2">&quot;-vf&quot;</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;subtitles=</span><span class="si">{</span><span class="n">tmp_srt</span><span class="si">}</span><span class="s2">:force_style=&#39;Alignment=6,Fontsize=48,Outline=8&#39;&quot;</span><span class="p">,</span>
                        <span class="p">]</span>
                    <span class="p">)</span>

                <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                    <span class="p">[</span><span class="o">*</span><span class="n">command</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;file:</span><span class="si">{</span><span class="n">output_video_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write_video</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">output_video_path</span><span class="p">),</span> <span class="n">video_array</span><span class="o">=</span><span class="n">video</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="n">video_fps</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RandomResizedCrop"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomResizedCrop">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;random_resized_crop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomResizedCrop</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class crops a random portion of an image and resize it to a given size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomResizedCrop.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomResizedCrop.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.random_resized_crop.interpolation&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.random_resized_crop.scale&quot;</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.random_resized_crop.aspect_ratio&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;--video-augmentation.random-resized-crop.scale should be a tuple of&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; length 2 such that 0.0 &lt;= scale[0] &lt; scale[1]. Got: </span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span>
            <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;--video-augmentation.random-resized-crop.aspect-ratio should be a&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; tuple of length 2 such that 0.0 &lt; ratio[0] &lt; ratio[1]. Got: </span><span class="si">{</span><span class="n">ratio</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">setup_size</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">_check_interpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span></div>

<div class="viewcode-block" id="RandomResizedCrop.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomResizedCrop.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-resized-crop.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use </span><span class="si">{}</span><span class="s2">. This flag is useful when you want to study the effect of&quot;</span>
            <span class="s2">&quot; different transforms.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-resized-crop.interpolation&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Desired interpolation method. Defaults to bilinear&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-resized-crop.scale&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">JsonValidator</span><span class="p">(</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]),</span>
            <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">0.08</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Specifies the lower and upper bounds for the random area of the crop,&quot;</span>
            <span class="s2">&quot; before resizing. The scale is defined with respect to the area of the&quot;</span>
            <span class="s2">&quot; original image. Defaults to (0.08, 1.0).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-resized-crop.aspect-ratio&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">JsonValidator</span><span class="p">(</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]),</span>
            <span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">4.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">),</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;lower and upper bounds for the random aspect ratio of the crop,&quot;</span>
            <span class="s2">&quot; before resizing. Defaults to (3./4., 4./3.).&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="RandomResizedCrop.get_params"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomResizedCrop.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">target_area</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">area</span>
            <span class="n">log_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="n">log_ratio</span><span class="p">))</span>

            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_area</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)))</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_area</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">)))</span>

            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">w</span> <span class="o">&lt;=</span> <span class="n">width</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">h</span> <span class="o">&lt;=</span> <span class="n">height</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span>

        <span class="c1"># Fallback to central crop.</span>
        <span class="n">in_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
        <span class="k">if</span> <span class="n">in_ratio</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">in_ratio</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">):</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">height</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">h</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># whole image</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">width</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">height</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
        <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>

        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>

        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_crop_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_resize_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(scale=</span><span class="si">{}</span><span class="s2">, ratio=</span><span class="si">{}</span><span class="s2">, interpolation=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RandomShortSizeResizeCrop"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomShortSizeResizeCrop">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;random_short_side_resize_crop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomShortSizeResizeCrop</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class first randomly resizes the input video such that shortest side is between</span>
<span class="sd">    specified minimum and maximum values, adn then crops a desired size video.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This class assumes that the video size after resizing is greater than or equal</span>
<span class="sd">        to the desired size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomShortSizeResizeCrop.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomShortSizeResizeCrop.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">interpolation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.random_short_side_resize_crop.interpolation&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">short_size_min</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.random_short_side_resize_crop.short_side_min&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">short_size_max</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.random_short_side_resize_crop.short_side_max&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">short_size_min</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Short side minimum value can&#39;t be None in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">short_size_max</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Short side maximum value can&#39;t be None in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">short_size_max</span> <span class="o">&lt;=</span> <span class="n">short_size_min</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Short side maximum value should be &gt;= short side minimum value in </span><span class="si">{}</span><span class="s2">. Got: </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">short_size_max</span><span class="p">,</span> <span class="n">short_size_min</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_side_min</span> <span class="o">=</span> <span class="n">short_size_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_side_max</span> <span class="o">=</span> <span class="n">short_size_max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">_check_interpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span></div>

<div class="viewcode-block" id="RandomShortSizeResizeCrop.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomShortSizeResizeCrop.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-short-side-resize-crop.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. This flag is useful when you want to study the&quot;</span>
            <span class="s2">&quot; effect of different transforms.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-short-side-resize-crop.interpolation&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Desired interpolation method. Defaults to bilinear&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-short-side-resize-crop.short-side-min&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Minimum value for video&#39;s shortest side. Defaults to None.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-short-side-resize-crop.short-side-max&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Maximum value for video&#39;s shortest side. Defaults to None.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="RandomShortSizeResizeCrop.get_params"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomShortSizeResizeCrop.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">th</span><span class="p">,</span> <span class="n">tw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="n">tw</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">==</span> <span class="n">th</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">th</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">tw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">tw</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">short_dim</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_side_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">short_side_max</span><span class="p">)</span>
        <span class="c1"># resize the video so that shorter side is short_dim</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_resize_fn</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">short_dim</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">)</span>

        <span class="n">clip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
        <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="c1"># Crop the video.</span>
        <span class="k">return</span> <span class="n">_crop_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(size=</span><span class="si">{}</span><span class="s2">, short_size_range=(</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">), interpolation=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_side_min</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">short_side_max</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RandomCrop"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomCrop">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;random_crop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomCrop</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method randomly crops a video area.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This class assumes that the input video size is greater than or equal to the</span>
<span class="sd">        desired size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomCrop.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomCrop.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">setup_size</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span></div>

<div class="viewcode-block" id="RandomCrop.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomCrop.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-crop.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. This flag is useful when you want to study the&quot;</span>
            <span class="s2">&quot; effect of different transforms.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

<div class="viewcode-block" id="RandomCrop.get_params"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomCrop.get_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">th</span><span class="p">,</span> <span class="n">tw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">==</span> <span class="n">tw</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">==</span> <span class="n">th</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span> <span class="o">-</span> <span class="n">th</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">tw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">tw</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
        <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">clip</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_crop_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(size=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>


<div class="viewcode-block" id="RandomHorizontalFlip"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomHorizontalFlip">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;random_horizontal_flip&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RandomHorizontalFlip</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements random horizontal flipping method</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomHorizontalFlip.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomHorizontalFlip.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.random_horizontal_flip.p&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span></div>

<div class="viewcode-block" id="RandomHorizontalFlip.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.RandomHorizontalFlip.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-horizontal-flip.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Use </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">. This flag is useful when you want to study the&quot;</span>
            <span class="s2">&quot; effect of different transforms.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.random-horizontal-flip.p&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Probability for random horizontal flip. Default to 0.5.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
            <span class="n">_check_rgb_video_tensor</span><span class="p">(</span><span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">)</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mask&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="CenterCrop"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CenterCrop">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;center_crop&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CenterCrop</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements center cropping method.</span>

<span class="sd">    .. note::</span>
<span class="sd">        This class assumes that the input size is greater than or equal to the desired</span>
<span class="sd">        size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CenterCrop.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CenterCrop.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Sequence</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Scale should be either an int or tuple of ints.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CenterCrop.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CenterCrop.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.center-crop.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use center cropping&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">_crop_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(size=(h=</span><span class="si">{}</span><span class="s2">, w=</span><span class="si">{}</span><span class="s2">))&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Resize"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.Resize">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;resize&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Resize</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class implements resizing operation.</span>

<span class="sd">    .. note::</span>
<span class="sd">    Two possible modes for resizing.</span>
<span class="sd">    1. Resize while maintaining aspect ratio. To enable this option, pass int as a size.</span>
<span class="sd">    2. Resize to a fixed size. To enable this option, pass a tuple of height and width</span>
<span class="sd">        as a size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Resize.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.Resize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.resize.size&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Size can not be None in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

        <span class="c1"># Possible modes.</span>
        <span class="c1"># 1. Resize while maintaining aspect ratio. To enable this option, pass int as a</span>
        <span class="c1"># size.</span>
        <span class="c1"># 2. Resize to a fixed size. To enable this option, pass a tuple of height and</span>
        <span class="c1"># width as a size.</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;The length of size should be either 1 or 2 in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">interpolation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.resize.interpolation&quot;</span><span class="p">,</span> <span class="s2">&quot;bilinear&quot;</span>
        <span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">_check_interpolation</span><span class="p">(</span><span class="n">interpolation</span><span class="p">)</span></div>

<div class="viewcode-block" id="Resize.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.Resize.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.resize.enable&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;use fixed resizing&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.resize.interpolation&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;bilinear&quot;</span><span class="p">,</span>
            <span class="n">choices</span><span class="o">=</span><span class="n">SUPPORTED_PYTORCH_INTERPOLATIONS</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Interpolation for resizing. Default is bilinear&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.resize.size&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;+&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Resize video to the specified size. If int is passed, then shorter&quot;</span>
            <span class="s2">&quot; side is resized to the specified size and longest side is resized while&quot;</span>
            <span class="s2">&quot; maintaining aspect ratio. Defaults to None.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_resize_fn</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(size=</span><span class="si">{}</span><span class="s2">, interpolation=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolation</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CropByBoundingBox"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CropByBoundingBox">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;crop_by_bounding_box&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">CropByBoundingBox</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Crops video frames based on bounding boxes and adjusts the @targets</span>
<span class="sd">    &quot;box_coordinates&quot; annotations.</span>
<span class="sd">    Before cropping, the bounding boxes are expanded with @multiplier, while the</span>
<span class="sd">    &quot;box_coordinates&quot; cover the original areas of the image.</span>
<span class="sd">    Note that the cropped images may be padded with 0 values in the boundaries of the</span>
<span class="sd">    cropped image when the bounding boxes are near the edges.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CropByBoundingBox.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CropByBoundingBox.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span>
        <span class="n">image_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.crop_by_bounding_box.multiplier&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">image_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.crop_by_bounding_box.image_size&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="n">image_size</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">image_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">),</span> <span class="s2">&quot;Please provide --video-augmentation.crop-by-bounding-box.image_size argument.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_first</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.crop_by_bounding_box.channel_first&quot;</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            data: mapping of: {</span>
<span class="sd">                &quot;samples&quot;: {</span>
<span class="sd">                    &quot;video&quot;: Tensor of shape: [N, C, T, H, W] if self.channel_first else [N, T, C, H, W]</span>
<span class="sd">                },</span>
<span class="sd">                &quot;targets&quot;: {</span>
<span class="sd">                    &quot;traces&quot;: {</span>
<span class="sd">                        &quot;&lt;object_trace_uuid&gt;&quot;: {</span>
<span class="sd">                            &quot;box_coordinates&quot;: FloatTensor[N, T, 4],  # x0, y0, x1, y1</span>
<span class="sd">                        }</span>
<span class="sd">                    },</span>
<span class="sd">                    &quot;labels&quot;: IntTensor[N, T],</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">traces</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">][</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span>
        <span class="n">trace_identity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">traces</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traces</span><span class="p">[</span><span class="n">trace_identity</span><span class="p">]</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_first</span><span class="p">:</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">movedim</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">video</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">expected_box_coordinates_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="n">box_coordinates</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;box_coordinates&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="n">box_coordinates</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">expected_box_coordinates_shape</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;Unexpected shape </span><span class="si">{</span><span class="n">trace</span><span class="p">[</span><span class="s1">&#39;box_coordinates&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">expected_box_coordinates_shape</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">expanded_corners</span><span class="p">,</span> <span class="n">box_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand_boxes</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="s2">&quot;box_coordinates&quot;</span><span class="p">])</span>

        <span class="n">expanded_corners</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">expanded_corners</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">())</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">int</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
            <span class="p">[</span><span class="n">N</span> <span class="o">*</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">video</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">video</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">images</span><span class="p">,</span> <span class="n">crop_corners</span><span class="p">,</span> <span class="n">result_placeholder</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">video</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">),</span> <span class="n">expanded_corners</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">result</span>
        <span class="p">):</span>
            <span class="n">result_placeholder</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">FV</span><span class="o">.</span><span class="n">resized_crop</span><span class="p">(</span>
                <span class="n">images</span><span class="p">,</span>
                <span class="n">left</span><span class="o">=</span><span class="n">crop_corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">top</span><span class="o">=</span><span class="n">crop_corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">width</span><span class="o">=</span><span class="n">crop_corners</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_corners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">height</span><span class="o">=</span><span class="n">crop_corners</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">crop_corners</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">][</span><span class="s2">&quot;traces&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">trace_identity</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">trace</span><span class="p">,</span> <span class="s2">&quot;box_coordinates&quot;</span><span class="p">:</span> <span class="n">box_coordinates</span><span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="CropByBoundingBox.expand_boxes"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CropByBoundingBox.expand_boxes">[docs]</a>    <span class="k">def</span> <span class="nf">expand_boxes</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">box_coordinates</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            box_coordinates: Tensor of shape [..., 4] with (x0, y0, x1, y1) in [0,1]</span>
<span class="sd">        Outputs (tuple items):</span>
<span class="sd">            expanded_corners: Tensor of shape [..., 4] with (x0, y0, x1, y1), containing</span>
<span class="sd">                the coordinates for cropping. Because of the expansion, coordinates</span>
<span class="sd">                could be negative or &gt;1.</span>
<span class="sd">            box_coordinates: Tensor of shape [..., 4] with (x0, y0, x1, y1) in [0,1] to</span>
<span class="sd">                be used as bounding boxes after cropping.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">expanded_corners</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">x0</span> <span class="o">-</span> <span class="n">dw</span><span class="p">,</span>
                <span class="n">y0</span> <span class="o">-</span> <span class="n">dh</span><span class="p">,</span>
                <span class="n">x1</span> <span class="o">+</span> <span class="n">dw</span><span class="p">,</span>
                <span class="n">x1</span> <span class="o">+</span> <span class="n">dh</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If multiplier is 1, new box_coordinates should cover the whole image (i.e.</span>
        <span class="c1"># [0., 0., 1., 1.]), as image was cropped based on the box_coordinates. For</span>
        <span class="c1"># multiplier &gt; 1, new box_coordinates should have a small margin within the</span>
        <span class="c1"># boundaries (i.e. [new_x0, new_y0, 1-new_x0, 1-new_y0]).</span>
        <span class="c1"># new_width = old_width * multiplier</span>
        <span class="c1"># =&gt; new_x0 = [(new_width - old_width) / 2] / new_width</span>
        <span class="c1">#           = (1 - 1/multiplier) / 2</span>
        <span class="n">box_coordinates</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">box_coordinates</span><span class="p">)</span>
        <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">box_coordinates</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">expanded_corners</span><span class="p">,</span> <span class="n">box_coordinates</span></div>

<div class="viewcode-block" id="CropByBoundingBox.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.CropByBoundingBox.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.crop-by-bounding-box.images-size&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">JsonValidator</span><span class="p">(</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]),</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Sizes [height, width] of the video frames after cropping.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.crop-by-bounding-box.channel-first&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If true, the video shape is [N, C, T, H, W]. Otherwise:&quot;</span>
            <span class="s2">&quot; [N, T, C, H, W].&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.crop-by-bounding-box.multiplier&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The bounding boxes get expanded by this multiplier before cropping.&quot;</span>
            <span class="s2">&quot; Useful for zooming in/out.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span></div></div>


<div class="viewcode-block" id="ShuffleAudios"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.ShuffleAudios">[docs]</a><span class="nd">@TRANSFORMATIONS_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;shuffle-audios&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;video&quot;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">ShuffleAudios</span><span class="p">(</span><span class="n">BaseTransformation</span><span class="p">):</span>
<div class="viewcode-block" id="ShuffleAudios.__init__"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.ShuffleAudios.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">opts</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span>
        <span class="n">is_training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">is_evaluation</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">item_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transforms a batch of audio-visual clips. Generates binary labels, useful for</span>
<span class="sd">        self-supervised audio-visual training.</span>

<span class="sd">        At each invocation, a subset of clips within video (batch) get their audios</span>
<span class="sd">        shuffled. The ratio of clips that participate in the shuffling is configurable</span>
<span class="sd">        by argparse options.</span>

<span class="sd">        When training, the shuffle order is random. When evaluating, the shuffle order</span>
<span class="sd">        is deterministic.</span>

<span class="sd">        Args:</span>
<span class="sd">            is_training: When False, decide to shuffle the audios or not</span>
<span class="sd">                deterministically.</span>
<span class="sd">            is_evaluation: Combined with @is_training, determines which shuffle ratio</span>
<span class="sd">                argument to use (train/val/eval).</span>
<span class="sd">            item_index: Used for deterministic shuffling based on the item_index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">item_index</span> <span class="o">=</span> <span class="n">item_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span> <span class="o">=</span> <span class="n">is_training</span>
        <span class="k">if</span> <span class="n">is_training</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.shuffle_audios.shuffle_ratio_train&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_evaluation</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.shuffle_audios.shuffle_ratio_test&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_ratio</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
                <span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.shuffle_audios.shuffle_ratio_val&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_frame_level_targets</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
            <span class="n">opts</span><span class="p">,</span>
            <span class="s2">&quot;video_augmentation.shuffle_audios.generate_frame_level_targets&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.shuffle_audios.target_key&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s2">&quot;video_augmentation.shuffle_audios.debug_mode&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShuffleAudios.add_arguments"><a class="viewcode-back" href="../../../autogen/data.transforms.html#data.transforms.video.ShuffleAudios.add_arguments">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">add_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parser</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.shuffle-ratio-train&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ratio of training videos with shuffled audio samples. Defaults to 0.5.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.shuffle-ratio-val&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Ratio of validation videos with shuffled audio samples. Defaults to &quot;</span>
                <span class="s2">&quot; 0.5.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.shuffle-ratio-test&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Ratio of test videos with shuffled audio samples. Defaults to 0.5.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.generate-frame-level-targets&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;If true, the generated targets will be 2-dimensional (n_clips x &quot;</span>
                <span class="s2">&quot;n_frames). Otherwise, targets will be 1 dimensional (n_clips).&quot;</span>
                <span class="s2">&quot; Defaults to False.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.target-key&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="s2">&quot;is_shuffled&quot;</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;Defaults to &#39;is_shuffled&#39;. Name of the sub-key in data[&#39;targets&#39;] &quot;</span>
                <span class="s2">&quot; to store the labels tensor. For each clip index `i`, we will have&quot;</span>
                <span class="s2">&quot; data[&#39;targets&#39;][&#39;is_shuffled&#39;][i] == 0 iff audio of the clip matches&quot;</span>
                <span class="s2">&quot; the video, otherwise 1.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--video-augmentation.shuffle-audios.debug-mode&quot;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;If enabled, the permutation used for shuffling the clip audios will be&quot;</span>
                <span class="s2">&quot; added to data[&#39;samples&#39;][&#39;metadata&#39;][&#39;shuffled_audio_permutation&#39;]&quot;</span>
                <span class="s2">&quot; for debugging purposes. Defaults to False.&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">parser</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_single_cycle_permutation</span><span class="p">(</span>
        <span class="n">numel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_training</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a permutation of values 0 to @numel-1 that has the following property:</span>
<span class="sd">        For each index 0 &lt;= i &lt; numel: result[i] != i.</span>

<span class="sd">        Args:</span>
<span class="sd">            numel: Number of elements in the output permutation (must be &gt;1).</span>
<span class="sd">            is_training: If true, the output permutation will be deterministic.</span>
<span class="sd">            device: Torch device (e.g. cuda, cpu) to use for output tensor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">numel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Cannot create a single-cycle permutation with &lt;= 1 elements.&quot;</span>

        <span class="n">deterministic_single_cycle_perm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">numel</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_training</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">deterministic_single_cycle_perm</span>

        <span class="n">random_perm</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">random_perm_inv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">random_perm</span><span class="p">)</span>
        <span class="n">random_perm_inv</span><span class="p">[</span><span class="n">random_perm</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">numel</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># Proof that this implementation satisfies output[i] != i criteria:</span>
        <span class="c1"># 1. We know deterministic_single_cycle_perm[i] != i, because of the way it is</span>
        <span class="c1">#    constructed ([n//2, n//2+1, ..., n, 1, 2, ..., n//2-1]).</span>
        <span class="c1"># 2. ``rand_perm`` is a non-deterministic random permutation, and</span>
        <span class="c1">#    ``rand_perm_inv`` is the inverse of `rand_perm`. That means for each</span>
        <span class="c1">#    0 &lt;= i &lt; numel, we have: rand_perm_inv[rand_perm[i]] == i.</span>
        <span class="c1"># 3. Proof by contradiction: Let&#39;s assume, for 0 &lt;= i &lt; numel, i == output[i]:</span>
        <span class="c1">#    Thus: random_perm[deterministic_single_cycle_perm[random_perm_inv]][i] == i</span>
        <span class="c1"># 4. For any two torch tensors a, b that expression `a[b]`` is valid, we have</span>
        <span class="c1">#    a[b][i] == a[b[i]]. Thus, we can rewrite the assumption of step 3 as:</span>
        <span class="c1">#    i == random_perm[deterministic_single_cycle_perm[random_perm_inv[i]]]</span>
        <span class="c1"># 5. Now, apply rand_perm_inv[] on both sides of the equality:</span>
        <span class="c1">#    rand_perm_inv[i] == deterministic_single_cycle_perm[random_perm_inv[i]]</span>
        <span class="c1">#    Then, alias rand_perm_inv[i] as x. Then we will have:</span>
        <span class="c1">#    x == deterministic_single_cycle_perm[x]</span>
        <span class="c1"># 6. Assumption of step (3) leads to (5) which contradicts (1). Thus, assumption</span>
        <span class="c1">#    of step (3) is false. Thus, output[i] != i</span>
        <span class="k">return</span> <span class="n">random_perm</span><span class="p">[</span><span class="n">deterministic_single_cycle_perm</span><span class="p">[</span><span class="n">random_perm_inv</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_random_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a pseudo random tensor of size n in range [0, 1]. For evaluation,</span>
<span class="sd">        the outcome is a deterministic function of n and `self.item_index`</span>

<span class="sd">        Args:</span>
<span class="sd">            n: Length of the output tensor.</span>

<span class="sd">        Returns: A tensor of length n, of random floats uniformly distributed between</span>
<span class="sd">            0-1. The output is deterministic iff self.is_training is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_training</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">item_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">def</span> <span class="nf">_random_participants_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a pseudo random boolean tensor of size n, where exactly ``int(</span>
<span class="sd">        self.shuffle_ratio * n)`` indices are True, and the rest are False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_outcome</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shuffle_ratio</span> <span class="o">*</span> <span class="n">n</span> <span class="o">-</span> <span class="mf">1e-8</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="n">audio</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;audio&quot;</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">audio</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shuffled_permutation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">audio</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
            <span class="n">is_shuffling_participant_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="kc">False</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">audio</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shuffled_permutation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_single_cycle_permutation</span><span class="p">(</span>
                <span class="n">N</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">audio</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">is_training</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">is_training</span>
            <span class="p">)</span>
            <span class="n">is_shuffling_participant_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_participants_mask</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
            <span class="n">shuffled_permutation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">is_shuffling_participant_mask</span><span class="p">,</span>
                <span class="n">shuffled_permutation</span><span class="p">,</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Insufficient clips (N=</span><span class="si">{N}</span><span class="s2">) in batch.&quot;</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;audio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">audio</span><span class="p">[</span><span class="n">shuffled_permutation</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_mode</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;metadata&quot;</span><span class="p">][</span>
                <span class="s2">&quot;shuffled_audio_permutation&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">shuffled_permutation</span>

        <span class="n">target_dims</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_frame_level_targets</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;samples&quot;</span><span class="p">][</span><span class="s2">&quot;video&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">target_dims</span><span class="p">],</span>
            <span class="n">device</span><span class="o">=</span><span class="n">audio</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">is_shuffling_participant_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># 1 means shuffled</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;targets&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="k">return</span> <span class="n">data</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (C) 2023 Apple Inc. All Rights Reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>